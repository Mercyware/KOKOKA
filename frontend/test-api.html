<!DOCTYPE html>
<html>
<head>
    <title>API Test - Class Subject Management</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; }
        .error { background: #ffe6e6; color: red; }
        .success { background: #e6ffe6; color: green; }
        button { padding: 10px 20px; margin: 5px; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>
    <h1>Class-Subject Management API Test</h1>
    
    <div class="section">
        <h2>1. Login First</h2>
        <input type="text" id="email" placeholder="Email (admin@greenwood.com)" value="admin@greenwood.com">
        <input type="password" id="password" placeholder="Password (admin123)" value="admin123">
        <button onclick="login()">Login</button>
        <div id="loginResult" class="result"></div>
    </div>
    
    <div class="section">
        <h2>2. Test Class-Subject History API</h2>
        <button onclick="testClassSubjectAPI()">Get Class-Subject History</button>
        <div id="classSubjectResult" class="result"></div>
    </div>
    
    <div class="section">
        <h2>3. Test Supporting APIs</h2>
        <button onclick="testClasses()">Get Classes</button>
        <button onclick="testSubjects()">Get Subjects</button>
        <button onclick="testAcademicYears()">Get Academic Years</button>
        <button onclick="testTeachers()">Get Teachers</button>
        <div id="supportingResult" class="result"></div>
    </div>
    
    <div class="section">
        <h2>4. Debug School Context</h2>
        <button onclick="debugSchoolContext()">Debug School Context</button>
        <div id="debugResult" class="result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let authToken = '';
        let schoolSubdomain = 'greenwood';
        
        // Set school subdomain in localStorage for testing
        localStorage.setItem('schoolSubdomain', schoolSubdomain);
        
        async function apiCall(endpoint, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                'X-School-Subdomain': schoolSubdomain,
                ...options.headers
            };
            
            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }
            
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    ...options,
                    headers
                });
                
                const data = await response.json();
                return { success: response.ok, data, status: response.status };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }
        
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('loginResult');
            
            const result = await apiCall('/auth/login', {
                method: 'POST',
                body: JSON.stringify({ email, password })
            });
            
            if (result.success) {
                authToken = result.data.token;
                schoolSubdomain = result.data.user?.school?.subdomain || schoolSubdomain;
                localStorage.setItem('token', authToken);
                localStorage.setItem('schoolSubdomain', schoolSubdomain);
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `<strong>Login Successful!</strong><br>
                    Token: ${authToken.substring(0, 20)}...<br>
                    School: ${result.data.user?.school?.name}<br>
                    Subdomain: ${schoolSubdomain}`;
            } else {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<strong>Login Failed:</strong><br><pre>${JSON.stringify(result, null, 2)}</pre>`;
            }
        }
        
        async function testClassSubjectAPI() {
            const resultDiv = document.getElementById('classSubjectResult');
            
            const result = await apiCall('/class-subject-history');
            
            if (result.success) {
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `<strong>Class-Subject History API Success!</strong><br>
                    Found ${result.data.data?.length || 0} assignments<br>
                    <details>
                        <summary>Full Response</summary>
                        <pre>${JSON.stringify(result.data, null, 2)}</pre>
                    </details>`;
            } else {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<strong>API Failed:</strong><br><pre>${JSON.stringify(result, null, 2)}</pre>`;
            }
        }
        
        async function testClasses() {
            const result = await apiCall('/classes');
            updateSupportingResult('Classes', result);
        }
        
        async function testSubjects() {
            const result = await apiCall('/subjects');
            updateSupportingResult('Subjects', result);
        }
        
        async function testAcademicYears() {
            const result = await apiCall('/academic-years');
            updateSupportingResult('Academic Years', result);
        }
        
        async function testTeachers() {
            const result = await apiCall('/teachers');
            updateSupportingResult('Teachers', result);
        }
        
        function updateSupportingResult(apiName, result) {
            const resultDiv = document.getElementById('supportingResult');
            const className = result.success ? 'result success' : 'result error';
            const status = result.success ? 
                `✅ ${apiName}: ${result.data.data?.length || 0} items` :
                `❌ ${apiName}: ${result.error || result.data?.message || 'Failed'}`;
            
            resultDiv.innerHTML += `<div class="${className}">${status}</div>`;
        }
        
        async function debugSchoolContext() {
            const resultDiv = document.getElementById('debugResult');
            
            const result = await apiCall('/class-subject-history/debug');
            
            if (result.success) {
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `<strong>Debug Info:</strong><br><pre>${JSON.stringify(result.data.debug, null, 2)}</pre>`;
            } else {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<strong>Debug Failed:</strong><br><pre>${JSON.stringify(result, null, 2)}</pre>`;
            }
        }
        
        // Load token from localStorage if available
        const savedToken = localStorage.getItem('token');
        if (savedToken) {
            authToken = savedToken;
            document.getElementById('loginResult').innerHTML = `<em>Found saved token: ${authToken.substring(0, 20)}...</em>`;
        }
    </script>
</body>
</html>